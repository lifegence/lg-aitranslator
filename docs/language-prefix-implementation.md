# Language Prefix Implementation Plan

## Overview

Implement URL-based language routing using language prefixes (`/en/`, `/ja/`, `/zh-CN/`) for the Lifegence AITranslator plugin.

**Author**: Lifegence Corporation (https://lifegence.com)
**Date**: 2025-01-21

---

## Architecture

### URL Structure

```
Original URL:  https://example.com/about/
English:       https://example.com/en/about/
Japanese:      https://example.com/ja/about/
Chinese (CN):  https://example.com/zh-CN/about/
```

**Design Decisions**:
- Default language (configured in settings) shows WITHOUT prefix
- Non-default languages show WITH prefix
- Preserves query parameters and fragments
- SEO-friendly with proper hreflang tags

---

## Component Overview

### 1. URL Rewrite System
**File**: `includes/class-url-rewriter.php`

**Responsibilities**:
- Detect language from URL path
- Rewrite URLs to add/remove language prefix
- Handle redirects for language switching
- Generate language-specific URLs

**Methods**:
```php
- init_hooks(): Register WordPress hooks
- detect_language(): Extract language from current URL
- add_language_prefix($url, $lang): Add language prefix to URL
- remove_language_prefix($url): Remove language prefix
- get_current_language(): Get active language
- redirect_to_language($lang): Redirect to language version
```

### 2. Content Translation Engine
**File**: `includes/class-content-translator.php`

**Responsibilities**:
- Hook into WordPress content filters
- Translate content on-the-fly
- Cache translations efficiently
- Handle post content, titles, excerpts, menus, widgets

**Hooks**:
```php
- the_title (filter): Translate post/page titles
- the_content (filter): Translate post/page content
- the_excerpt (filter): Translate excerpts
- widget_title (filter): Translate widget titles
- widget_text (filter): Translate widget text content
- nav_menu_item (filter): Translate menu items
```

**Translation Flow**:
```
1. Hook triggered (e.g., the_content)
2. Get current language
3. If language == default_language: return original
4. Check cache for translation
5. If cached: return cached translation
6. If not cached:
   - Call translation service (Gemini/OpenAI)
   - Store in cache
   - Return translation
```

### 3. Language Switcher Updates
**File**: `includes/class-language-switcher-widget.php`

**Changes**:
- Generate URLs with language prefixes
- Highlight current language based on URL
- Update `changeLanguage()` to use prefix URLs

---

## Implementation Details

### Phase 1: URL Rewrite System

#### 1.1 Language Detection
```php
// Detect language from URL path
// /ja/about/ -> 'ja'
// /zh-CN/products/ -> 'zh-CN'
// /about/ -> default language
```

**Hook**: `init` (priority: 5, early execution)

#### 1.2 Rewrite Rules
```php
add_rewrite_rule(
    '^([a-z]{2}|[a-z]{2}-[A-Z]{2})/(.*)$',
    'index.php?lang=$matches[1]&original_path=$matches[2]',
    'top'
);
```

**Query Vars**:
- `lang`: Language code (e.g., 'ja', 'zh-CN')
- `original_path`: Original request path without language prefix

#### 1.3 URL Generation
```php
// Filter all URLs generated by WordPress
add_filter('home_url', 'add_language_prefix', 10, 2);
add_filter('post_link', 'add_language_prefix', 10, 2);
add_filter('page_link', 'add_language_prefix', 10, 2);
add_filter('category_link', 'add_language_prefix', 10, 2);
add_filter('term_link', 'add_language_prefix', 10, 2);
```

---

### Phase 2: Content Translation

#### 2.1 Translation Hooks
```php
class LG_Content_Translator {
    public function init_hooks() {
        add_filter('the_title', [$this, 'translate_title'], 10, 2);
        add_filter('the_content', [$this, 'translate_content'], 999);
        add_filter('the_excerpt', [$this, 'translate_excerpt'], 10, 2);
        add_filter('widget_title', [$this, 'translate_widget_title'], 10, 3);
        add_filter('widget_text', [$this, 'translate_widget_text'], 10, 3);
    }
}
```

#### 2.2 Translation Strategy

**Cache Key Format**:
```
lg_aitrans_{content_type}_{content_id}_{target_lang}_{hash}

Examples:
lg_aitrans_post_title_123_ja_a1b2c3d4
lg_aitrans_post_content_123_ja_e5f6g7h8
lg_aitrans_widget_title_5_zh-CN_i9j0k1l2
```

**Content Types**:
- `post_title`: Post/page titles
- `post_content`: Post/page main content
- `post_excerpt`: Post excerpts
- `widget_title`: Widget titles
- `widget_text`: Widget text content
- `menu_item`: Menu item labels

#### 2.3 Translation Process
```php
public function translate_content($content) {
    // 1. Get current language
    $current_lang = $this->url_rewriter->get_current_language();
    $default_lang = $this->get_default_language();

    // 2. Skip if default language
    if ($current_lang === $default_lang) {
        return $content;
    }

    // 3. Check cache
    $cache_key = $this->generate_cache_key('content', $content, $current_lang);
    $cached = $this->cache->get($cache_key);

    if ($cached !== false) {
        return $cached;
    }

    // 4. Translate via API
    $translated = $this->translation_service->translate(
        $content,
        $default_lang,
        $current_lang
    );

    // 5. Cache result
    $this->cache->set($cache_key, $translated);

    return $translated;
}
```

---

### Phase 3: Language Switcher Updates

#### 3.1 URL Generation
```php
// Update changeLanguage() in frontend.js
function changeLanguage(lang) {
    var currentPath = window.location.pathname;
    var newPath;

    // Remove existing language prefix
    currentPath = currentPath.replace(/^\/(en|ja|zh-CN|es|fr|de|it|pt|ru|ar|hi|th|vi|id|tr|pl|nl|sv|ko|zh-TW)\//i, '/');

    // Add new language prefix (skip for default language)
    if (lang !== lgAITranslatorFrontend.defaultLang) {
        newPath = '/' + lang + currentPath;
    } else {
        newPath = currentPath;
    }

    // Navigate to new URL
    window.location.href = newPath + window.location.search + window.location.hash;
}
```

#### 3.2 Current Language Detection
```php
// Update widget to detect language from URL
private function get_current_language() {
    $url_rewriter = new LG_URL_Rewriter();
    return $url_rewriter->get_current_language();
}
```

---

## File Structure

```
lg-aitranslator/
├── includes/
│   ├── class-url-rewriter.php          [NEW]
│   ├── class-content-translator.php    [NEW]
│   ├── class-language-switcher-widget.php [UPDATE]
│   ├── class-translation-service-factory.php [EXISTS]
│   ├── class-gemini-translation-service.php [EXISTS]
│   ├── class-openai-translation-service.php [EXISTS]
│   └── class-translation-cache.php     [EXISTS]
├── assets/
│   └── js/
│       └── frontend.js                  [UPDATE]
├── lg-aitranslator.php                  [UPDATE]
└── docs/
    └── language-prefix-implementation.md [THIS FILE]
```

---

## Implementation Sequence

### Step 1: Create URL Rewriter Class
- [ ] Create `includes/class-url-rewriter.php`
- [ ] Implement language detection from URL
- [ ] Add rewrite rules for language prefixes
- [ ] Filter WordPress URLs to add language prefixes
- [ ] Handle redirects for language switching

### Step 2: Create Content Translator Class
- [ ] Create `includes/class-content-translator.php`
- [ ] Hook into WordPress content filters
- [ ] Implement translation caching strategy
- [ ] Integrate with existing translation services
- [ ] Add error handling and fallbacks

### Step 3: Update Language Switcher
- [ ] Update `frontend.js` changeLanguage() function
- [ ] Update widget current language detection
- [ ] Generate language-specific URLs in widget
- [ ] Update shortcode to use URL-based detection

### Step 4: Update Main Plugin File
- [ ] Load new classes in `lg-aitranslator.php`
- [ ] Initialize URL rewriter early (init priority 5)
- [ ] Initialize content translator (default priority)
- [ ] Flush rewrite rules on activation

### Step 5: Testing
- [ ] Test language detection from URLs
- [ ] Test content translation on posts/pages
- [ ] Test language switcher navigation
- [ ] Test cache functionality
- [ ] Test SEO (hreflang tags, canonical URLs)
- [ ] Test with different WordPress configurations

---

## Configuration

### Settings Updates

Add to admin settings:

```php
// General Tab - URL Structure section
- [ ] Use language prefix in URLs (recommended)
- [ ] Show default language in URL: Yes/No
```

**Default Behavior**:
- Language prefix enabled by default
- Default language does NOT show in URL (cleaner)
- Example: `/about/` (English default), `/ja/about/` (Japanese)

---

## SEO Considerations

### 1. Hreflang Tags
```html
<link rel="alternate" hreflang="en" href="https://example.com/about/" />
<link rel="alternate" hreflang="ja" href="https://example.com/ja/about/" />
<link rel="alternate" hreflang="zh-CN" href="https://example.com/zh-CN/about/" />
<link rel="alternate" hreflang="x-default" href="https://example.com/about/" />
```

**Implementation**: Hook into `wp_head`

### 2. Canonical URLs
```html
<link rel="canonical" href="https://example.com/ja/about/" />
```

**Implementation**: Filter `get_canonical_url`

### 3. Language Meta Tags
```html
<meta property="og:locale" content="ja_JP" />
<html lang="ja">
```

**Implementation**: Filter `language_attributes`

---

## Cache Strategy

### Cache Structure
```
Transient: lg_aitrans_{type}_{id}_{lang}_{hash}
TTL: From settings (default 86400 seconds / 24 hours)
```

### Cache Invalidation
- Clear on post/page update
- Clear on settings change
- Clear on manual cache flush
- Clear when translation service changes

### Cache Statistics
Track:
- Total cached items
- Cache hit rate
- API calls saved
- Cost savings estimate

---

## Error Handling

### Translation Failures
1. Log error to WordPress debug.log
2. Return original content (graceful degradation)
3. Display admin notice if API quota exceeded
4. Retry logic for temporary failures

### URL Rewrite Failures
1. Fall back to query parameter method (`?lang=ja`)
2. Log warning in debug mode
3. Admin notice to flush rewrite rules

---

## Performance Optimization

### 1. Lazy Translation
- Translate only visible content
- Skip translation for admin users (optional setting)
- Skip translation for bots (optional setting)

### 2. Batch Translation
- Combine multiple content pieces into single API call
- Reduce API overhead
- Respect API rate limits

### 3. Edge Caching
- Cache-friendly headers for translated pages
- Compatible with CDN caching
- Vary header for language detection

---

## Migration from Current Implementation

### Current State
- Language stored in cookie: `lg_aitranslator_lang`
- URL parameter: `?lang=ja`
- No actual translation happening (placeholder)

### Migration Steps
1. Keep cookie as fallback for language preference
2. Prioritize URL prefix over cookie
3. Redirect old `?lang=` URLs to prefix URLs
4. Clear old placeholder JavaScript code
5. Activate content translation hooks

### Backward Compatibility
- Support `?lang=` parameter with 301 redirect to prefix URL
- Maintain cookie for user preference
- Graceful degradation if rewrite rules fail

---

## Testing Checklist

### URL Rewriting
- [ ] `/en/about/` correctly detects English
- [ ] `/ja/about/` correctly detects Japanese
- [ ] `/zh-CN/products/` correctly handles hyphenated codes
- [ ] `/about/` shows default language
- [ ] Query parameters preserved: `/ja/about/?page=2`
- [ ] Fragments preserved: `/ja/about/#section`
- [ ] 404 pages work in all languages
- [ ] Search pages work in all languages

### Content Translation
- [ ] Post titles translate correctly
- [ ] Post content translates correctly
- [ ] Post excerpts translate correctly
- [ ] Page content translates correctly
- [ ] Widget titles translate correctly
- [ ] Widget text translates correctly
- [ ] Menu items translate correctly
- [ ] Category/tag names translate correctly

### Language Switcher
- [ ] Dropdown shows all languages
- [ ] Current language highlighted
- [ ] Switching languages changes URL
- [ ] Switching preserves current page
- [ ] Widget works on all page types
- [ ] Shortcode works on all page types

### Caching
- [ ] Translations cached correctly
- [ ] Cache keys unique per language
- [ ] Cache invalidation works
- [ ] Cache statistics accurate
- [ ] Manual cache clear works

### SEO
- [ ] Hreflang tags present and correct
- [ ] Canonical URLs correct
- [ ] Language meta tags correct
- [ ] HTML lang attribute correct
- [ ] Sitemap includes all languages (future)

### Performance
- [ ] Initial page load reasonable
- [ ] Cached pages load fast
- [ ] API calls minimized
- [ ] No N+1 query issues
- [ ] Memory usage acceptable

---

## Future Enhancements

### Phase 4: Advanced Features
- [ ] Multilingual sitemap generation
- [ ] Translation memory (reuse translations)
- [ ] Glossary support (consistent terminology)
- [ ] Custom translation overrides
- [ ] Translation editor UI
- [ ] Language-specific media (images, videos)
- [ ] RTL language support (Arabic, Hebrew)
- [ ] Subdomain support (`ja.example.com`)
- [ ] CDN integration for translated pages

---

## References

### WordPress Rewrite API
- https://developer.wordpress.org/reference/functions/add_rewrite_rule/
- https://developer.wordpress.org/reference/functions/flush_rewrite_rules/

### WordPress Filter Hooks
- https://developer.wordpress.org/reference/hooks/the_content/
- https://developer.wordpress.org/reference/hooks/the_title/

### SEO Best Practices
- https://developers.google.com/search/docs/specialty/international/localized-versions
- https://yoast.com/hreflang-ultimate-guide/

---

## Conclusion

This implementation provides a solid foundation for URL-based multilingual support with AI-powered translation. The language prefix approach is SEO-friendly, user-friendly, and follows WordPress best practices.

**Next Steps**: Begin implementation with Step 1 (URL Rewriter Class)

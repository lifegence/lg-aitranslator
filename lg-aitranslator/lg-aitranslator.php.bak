<?php
/**
 * Plugin Name: LG AI Translator
 * Plugin URI: https://github.com/yourusername/lg-aitranslator
 * Description: AI-powered multilingual translation plugin using Gemini and OpenAI for WordPress websites.
 * Version: 1.0.0
 * Author: Your Name
 * Author URI: https://yourwebsite.com
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: lg-aitranslator
 * Domain Path: /languages
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

// Define plugin constants
define('LG_AITRANS_VERSION', '1.0.0');
define('LG_AITRANS_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('LG_AITRANS_PLUGIN_URL', plugin_dir_url(__FILE__));
define('LG_AITRANS_PLUGIN_FILE', __FILE__);

/**
 * Main plugin class
 */
class LG_AITranslator {

    /**
     * Singleton instance
     */
    private static $instance = null;

    /**
     * Supported languages array
     */
    public static $languages = array(
        'en' => 'English',
        'ja' => '日本語',
        'zh-CN' => '简体中文',
        'zh-TW' => '繁體中文',
        'ko' => '한국어',
        'es' => 'Español',
        'fr' => 'Français',
        'de' => 'Deutsch',
        'it' => 'Italiano',
        'pt' => 'Português',
        'ru' => 'Русский',
        'ar' => 'العربية',
        'hi' => 'हिन्दी',
        'th' => 'ไทย',
        'vi' => 'Tiếng Việt',
        'id' => 'Bahasa Indonesia',
        'tr' => 'Türkçe',
        'pl' => 'Polski',
        'nl' => 'Nederlands',
        'sv' => 'Svenska'
    );

    /**
     * Get singleton instance
     */
    public static function get_instance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    /**
     * Constructor
     */
    private function __construct() {
        $this->load_dependencies();
        $this->init_hooks();
    }

    /**
     * Load plugin dependencies
     */
    private function load_dependencies() {
        // Core classes
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-translation-service-interface.php';
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-translation-service-factory.php';
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-gemini-translation-service.php';
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-openai-translation-service.php';
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-translation-cache.php';
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-api-key-manager.php';

        // Admin classes
        if (is_admin()) {
            require_once LG_AITRANS_PLUGIN_DIR . 'admin/class-admin-settings.php';
            require_once LG_AITRANS_PLUGIN_DIR . 'admin/class-admin-ajax.php';
        }

        // Widget
        require_once LG_AITRANS_PLUGIN_DIR . 'includes/class-language-switcher-widget.php';
    }

    /**
     * Initialize WordPress hooks
     */
    private function init_hooks() {
        // Activation/Deactivation
        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));

        // Admin hooks
        add_action('admin_menu', array($this, 'add_admin_menu'));
        add_action('admin_enqueue_scripts', array($this, 'enqueue_admin_scripts'));

        // Frontend hooks
        add_action('wp_enqueue_scripts', array($this, 'enqueue_frontend_scripts'));
        add_action('widgets_init', array($this, 'register_widgets'));

        // Shortcodes
        add_shortcode('lg-translator', array($this, 'language_switcher_shortcode'));

        // Load text domain
        add_action('plugins_loaded', array($this, 'load_textdomain'));

        // REST API
        add_action('rest_api_init', array($this, 'register_rest_routes'));
    }

    /**
     * Plugin activation
     */
    public function activate() {
        $default_settings = array(
            'enabled' => false,
            'provider' => 'gemini',
            'model' => 'gemini-2.5-flash',
            'default_language' => 'en',
            'supported_languages' => array('en', 'ja', 'zh-CN', 'es', 'fr'),
            'cache_enabled' => true,
            'cache_ttl' => 86400,
            'cache_backend' => 'transients',
            'translation_quality' => 'standard',
            'rate_limit_enabled' => true,
            'rate_limit_per_hour' => 1000,
            'monthly_budget_limit' => 50,
            'auto_disable_on_budget' => false
        );

        add_option('lg_aitranslator_settings', $default_settings);
        add_option('lg_aitranslator_version', LG_AITRANS_VERSION);
        add_option('lg_aitranslator_cache_version', 1);
    }

    /**
     * Plugin deactivation
     */
    public function deactivate() {
        // Cleanup tasks if needed
    }

    /**
     * Add admin menu
     */
    public function add_admin_menu() {
        add_options_page(
            __('LG AI Translator Settings', 'lg-aitranslator'),
            __('LG AI Translator', 'lg-aitranslator'),
            'manage_options',
            'lg-aitranslator',
            array($this, 'render_admin_page')
        );
    }

    /**
     * Render admin settings page
     */
    public function render_admin_page() {
        if (!class_exists('LG_AITranslator_Admin_Settings')) {
            return;
        }

        $admin_settings = new LG_AITranslator_Admin_Settings();
        $admin_settings->render();
    }

    /**
     * Enqueue admin scripts and styles
     */
    public function enqueue_admin_scripts($hook) {
        if ($hook !== 'settings_page_lg-aitranslator') {
            return;
        }

        wp_enqueue_style(
            'lg-aitranslator-admin',
            LG_AITRANS_PLUGIN_URL . 'admin/css/admin.css',
            array(),
            LG_AITRANS_VERSION
        );

        wp_enqueue_script(
            'lg-aitranslator-admin',
            LG_AITRANS_PLUGIN_URL . 'admin/js/admin.js',
            array('jquery'),
            LG_AITRANS_VERSION,
            true
        );

        wp_localize_script('lg-aitranslator-admin', 'lgAITranslator', array(
            'ajaxurl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('lg_aitranslator_admin'),
            'strings' => array(
                'testing' => __('Testing...', 'lg-aitranslator'),
                'clearing' => __('Clearing...', 'lg-aitranslator'),
                'success' => __('Success', 'lg-aitranslator'),
                'error' => __('Error', 'lg-aitranslator')
            )
        ));
    }

    /**
     * Enqueue frontend scripts and styles
     */
    public function enqueue_frontend_scripts() {
        $settings = get_option('lg_aitranslator_settings', array());

        if (empty($settings['enabled'])) {
            return;
        }

        wp_enqueue_style(
            'lg-aitranslator-frontend',
            LG_AITRANS_PLUGIN_URL . 'assets/css/frontend.css',
            array(),
            LG_AITRANS_VERSION
        );

        wp_enqueue_script(
            'lg-aitranslator-frontend',
            LG_AITRANS_PLUGIN_URL . 'assets/js/frontend.js',
            array('jquery'),
            LG_AITRANS_VERSION,
            true
        );

        wp_localize_script('lg-aitranslator-frontend', 'lgAITranslatorFrontend', array(
            'ajaxurl' => admin_url('admin-ajax.php'),
            'resturl' => rest_url('lg-aitranslator/v1/'),
            'nonce' => wp_create_nonce('lg_aitranslator_frontend'),
            'currentLang' => $this->get_current_language(),
            'defaultLang' => $settings['default_language'] ?? 'en'
        ));
    }

    /**
     * Register widgets
     */
    public function register_widgets() {
        register_widget('LG_Language_Switcher_Widget');
    }

    /**
     * Language switcher shortcode
     */
    public function language_switcher_shortcode($atts) {
        $atts = shortcode_atts(array(
            'type' => 'dropdown',
            'flags' => 'yes',
            'native_names' => 'yes'
        ), $atts);

        $widget = new LG_Language_Switcher_Widget();
        return $widget->render_switcher($atts);
    }

    /**
     * Load plugin text domain
     */
    public function load_textdomain() {
        load_plugin_textdomain(
            'lg-aitranslator',
            false,
            dirname(plugin_basename(__FILE__)) . '/languages/'
        );
    }

    /**
     * Register REST API routes
     */
    public function register_rest_routes() {
        register_rest_route('lg-aitranslator/v1', '/translate', array(
            'methods' => 'POST',
            'callback' => array($this, 'rest_translate'),
            'permission_callback' => '__return_true'
        ));

        register_rest_route('lg-aitranslator/v1', '/languages', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_get_languages'),
            'permission_callback' => '__return_true'
        ));
    }

    /**
     * REST API: Translate text
     */
    public function rest_translate($request) {
        $settings = get_option('lg_aitranslator_settings', array());

        if (empty($settings['enabled'])) {
            return new WP_Error('disabled', __('Translation service is disabled', 'lg-aitranslator'), array('status' => 403));
        }

        $text = $request->get_param('text');
        $target_lang = $request->get_param('target_lang');
        $source_lang = $request->get_param('source_lang') ?: $settings['default_language'];

        if (empty($text) || empty($target_lang)) {
            return new WP_Error('missing_params', __('Missing required parameters', 'lg-aitranslator'), array('status' => 400));
        }

        try {
            $service = LG_Translation_Service_Factory::create();
            $translation = $service->translate_text($text, $source_lang, $target_lang);

            return array(
                'success' => true,
                'translation' => $translation,
                'source_lang' => $source_lang,
                'target_lang' => $target_lang
            );
        } catch (Exception $e) {
            return new WP_Error('translation_failed', $e->getMessage(), array('status' => 500));
        }
    }

    /**
     * REST API: Get supported languages
     */
    public function rest_get_languages($request) {
        $settings = get_option('lg_aitranslator_settings', array());
        $supported = $settings['supported_languages'] ?? array();

        $languages = array();
        foreach ($supported as $code) {
            if (isset(self::$languages[$code])) {
                $languages[$code] = self::$languages[$code];
            }
        }

        return array(
            'languages' => $languages,
            'default' => $settings['default_language'] ?? 'en',
            'current' => $this->get_current_language()
        );
    }

    /**
     * Get current language
     */
    private function get_current_language() {
        $settings = get_option('lg_aitranslator_settings', array());
        $default = $settings['default_language'] ?? 'en';

        // Check cookie
        if (isset($_COOKIE['lg_aitranslator_lang'])) {
            return sanitize_text_field($_COOKIE['lg_aitranslator_lang']);
        }

        // Check query parameter
        if (isset($_GET['lang'])) {
            return sanitize_text_field($_GET['lang']);
        }

        return $default;
    }
}

// Initialize the plugin
function lg_aitranslator() {
    return LG_AITranslator::get_instance();
}

// Start the plugin
lg_aitranslator();
